<style>
    .modal-backdrop {
        z-index: 0 !important;
    }
</style>

<ul class="nav navbar-nav navbar-right">
    <li>
        <a href="#" data-toggle="modal" data-target="#notification-modal">
            <span aria-hidden="true" style="margin-right: 4px" class="glyphicon glyphicon-globe"></span>
            <span id="notification-count" class="badge">0</span>
        </a>
    </li>
</ul>

<!-- Modal -->
<div class="modal fade" id="notification-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Notifications</h4>
            </div>
            <div class="modal-body">
                <div id="notification" style="height: 500px; overflow-y: auto">
                    <table id="table-messages" class="table table-condensed table-hover">
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div style="display: none">
<audio id="notification-sound" controls>
    <source src="@Url.Content("~/Content/sounds/skype.mp3")" type="audio/mp3">
</audio>
</div>
<!--Reference the SignalR library. -->
@Scripts.Render("~/bundles/signalr")
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>

<!--Add script to update the page and send messages.-->
<script>
    $(function () {
        // Declare a proxy to reference the hub.
        var hub = $.connection.sqlDependencyHub;
        // Create a function that the hub can call to send messages.
        hub.client.updateNotificationSqlDependency = function () {
            getAllMessages();
        };

        // Start the connection.
        $.connection.hub.start().done(function () {
            console.log("Connected!");
            getAllMessages();
        });

        function getAllMessages() {
            $.ajax({
                url: '@Url.Content("~/SqlDependency/GetJsonMessages")',
                contentType: 'application/json; charset=utf-8',
                type: 'GET'
            }).success(function (result) {
                $("#notification-count").text(result.length);
                $("#table-messages > tbody").html("");
                $.each(result, function (index, item) {
                    var htmlString = "<tr>";
                    htmlString += "<td>" + (index + 1) + "</td>";
                    htmlString += "<td>" + item.MessageContent + "</td>";
                    htmlString += "<td>" + item.UserName + "</td>";
                    htmlString += "<td>" + item.CreatedDate + "</td>";
                    htmlString += "<td style='width: 1%'><button data-message-id='" + item.Id + "' class='btn-trash btn btn-sm btn-danger'><span class='glyphicon glyphicon-trash'></span></button></td>";
                    htmlString += "</tr>";

                    $("#table-messages > tbody:last").prepend(htmlString);
                });
                // sound
                // playSound();
            }).error(function (result) {
                console.log("Error:", result);
            });

            console.log("getAllMessages");
        }

        // REMOVE SUBJECT
        $('#table-messages').on('click', 'button.btn-trash', function () {
            var messageId = $(this).data("message-id");
            var data = { "id": messageId };
            $.ajax({
                url: '@Url.Content("~/SqlDependency/DeleteMessage")',
                type: "Post",
                data: JSON.stringify(data),
                contentType: 'application/json; charset=utf-8',
                success: function (result) {
                    $(this).parent().parent().hide(500);
                },
                error: function (result) { alert('error: ' + result); }
            });
        });

        // PLAY SOUND
        function playSound() {
            var audio = $("#notification-sound")[0];
            audio.play();
        };
    });
</script>
